@model GoCoffeeTea.Models.Product

@{
    ViewData["Title"] = "Chỉnh sửa Sản phẩm";
    // Đảm bảo biến 'materials' được khai báo ở đây, trong khối @{}
    var materials = (List<GoCoffeeTea.Models.Material>)ViewBag.Materials;
}

<h2 class="mb-4 text-info">✏️ Chỉnh sửa Sản phẩm: @Model.Name</h2>
<hr />

<form asp-action="Edit" method="post">
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm p-4 mb-4">
                <h5>Thông tin Sản phẩm</h5>
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                
                <input type="hidden" asp-for="ProductID" />
                
                <div class="mb-3">
                    <label asp-for="Name" class="form-label">Tên Sản phẩm (*)</label>
                    <input asp-for="Name" class="form-control" />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="CategoryID" class="form-label">Danh mục (*)</label>
                    <select asp-for="CategoryID" class="form-select" asp-items="ViewBag.CategoryID">
                        <option value="">-- Chọn Danh mục --</option>
                    </select>
                    <span asp-validation-for="CategoryID" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="Price" class="form-label">Giá bán (*)</label>
                    <input asp-for="Price" class="form-control" type="number" step="1000" min="0" />
                    <span asp-validation-for="Price" class="text-danger"></span>
                </div>
                
                <div class="mb-3 form-check">
                    <input class="form-check-input" asp-for="IsActive" />
                    <label class="form-check-label" asp-for="IsActive">
                        @Html.DisplayNameFor(model => model.IsActive) (Tắt để ẩn khỏi Menu)
                    </label>
                </div>
                
                <div class="mb-3">
                    <label asp-for="Description" class="form-label">Mô tả</label>
                    <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-sm p-4">
                <h5>Cập nhật Công thức & Nguyên vật liệu</h5>
                <p class="text-muted">Chỉnh sửa/Thêm nguyên vật liệu cần thiết.</p>

                <div id="recipe-items">
                    </div>

                <button type="button" class="btn btn-sm btn-outline-secondary mt-3" onclick="addRecipeRow()">
                    <i class="fas fa-plus"></i> Thêm Nguyên vật liệu mới
                </button>
            </div>
        </div>
    </div>
    
    <div class="mt-4 text-center">
        <button type="submit" class="btn btn-lg btn-info me-3 text-white">
            <i class="fas fa-save"></i> Lưu Thay đổi
        </button>
        <a asp-action="Index" class="btn btn-lg btn-secondary">Quay lại</a>
    </div>
</form>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        // 1. CHUYỂN DANH SÁCH NGUYÊN VẬT LIỆU TỪ C# SANG JS
        var materialList = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(materials.Select(m => new { 
                             MaterialID = m.MaterialID, 
                             Name = $"{m.Name} ({m.Unit})" 
                          })));

        // 2. Hàm xây dựng thẻ <select>
        function buildMaterialSelect(currentId = null) {
            var selectHtml = '<select name="MaterialID" class="form-select" required>' +
                             '<option value="">-- Chọn Nguyên vật liệu --</option>';
            
            materialList.forEach(function(mat) {
                var selected = currentId == mat.MaterialID ? 'selected' : '';
                selectHtml += `<option value="${mat.MaterialID}" ${selected}>${mat.Name}</option>`;
            });
            
            selectHtml += '</select>';
            return selectHtml;
        }

        // 3. Hàm tạo dòng Recipe mới
        function addRecipeRow(recipeId = 0, materialId = 0, quantity = '') {
            var selectControl = buildMaterialSelect(materialId);
            
            var quantityValue = quantity ? parseFloat(quantity).toFixed(4) : '';

            var hiddenIdInput = recipeId > 0 ? `<input type="hidden" name="RecipeID" value="${recipeId}" />` : '';

            var template = `
                <div class="input-group mb-2 recipe-row">
                    ${hiddenIdInput}
                    ${selectControl}
                    <input type="number" name="QuantityNeeded" class="form-control" placeholder="Số lượng cần (VD: 50)" step="any" min="0.0001" required value="${quantityValue}">
                    <button type="button" class="btn btn-danger" onclick="removeRecipeRow(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.getElementById('recipe-items').insertAdjacentHTML('beforeend', template);
        }

        // 4. Hàm xóa dòng Nguyên liệu
        function removeRecipeRow(button) {
            button.closest('.input-group').remove();
        }
        
        // 5. KHỞI TẠO DỮ LIỆU ĐÃ LƯU KHI CHỈNH SỬA
        document.addEventListener('DOMContentLoaded', function() {
            // FIX CS0103: Sử dụng khối để bao bọc logic C#
            @{
                if (Model.Recipes != null && Model.Recipes.Any())
                {
                    // Chuyển sang context JS: Bắt buộc phải dùng <text> để bao bọc các lệnh JS CÓ CHỨA C#
                    <text> 
                    @foreach (var recipe in Model.Recipes)
                    {
                        // Gọi hàm JS: Bắt buộc phải có @: trước lệnh JS
                        @:addRecipeRow(@recipe.RecipeID, @recipe.MaterialID, '@recipe.QuantityNeeded.ToString("F4")');
                    }
                    </text>
                }
                else
                {
                    // Chuyển sang context JS: Bắt buộc phải có @: trước lệnh JS
                    @:addRecipeRow(); 
                }
            }
        });
    </script>
}