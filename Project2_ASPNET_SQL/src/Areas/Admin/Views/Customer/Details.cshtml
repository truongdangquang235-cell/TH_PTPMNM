@model GoCoffeeTea.Models.Customer

@{
    ViewData["Title"] = $"Chi tiết Khách hàng: {Model.FullName}";

    // Sắp xếp đơn hàng theo ngày giảm dần
    var sortedOrders = Model.Orders?.OrderByDescending(o => o.OrderDate).ToList();
}

<h2 class="mb-4 text-primary">👤 Chi tiết Khách hàng</h2>
<hr />

<div class="row">

    @* PHẦN 1: THÔNG TIN HỒ SƠ KHÁCH HÀNG *@
    <div class="col-md-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Thông tin Hồ sơ</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-5">Tên:</dt>
                    <dd class="col-sm-7"><strong>@Model.FullName</strong></dd>

                    <dt class="col-sm-5">ID:</dt>
                    <dd class="col-sm-7">#@Model.CustomerID</dd>

                    <dt class="col-sm-5">Điện thoại:</dt>
                    <dd class="col-sm-7">@(Model.PhoneNumber ?? "N/A")</dd>

                    <dt class="col-sm-5">Email:</dt>
                    <dd class="col-sm-7">@(Model.Email ?? "N/A")</dd>

                    <dt class="col-sm-5">Thành viên:</dt>
                    <dd class="col-sm-7">
                        @if (Model.IsLoyalty)
                        {
                            <span class="badge bg-success">Thành viên Thân thiết</span>
                        }
                        else
                        {
                            <span class="badge bg-danger">Khách Vãng lai</span>
                        }
                    </dd>
                </dl>
            </div>
        </div>

        @* THÔNG TIN CẤP ĐỘ THÂN THIẾT *@
        @if (Model.IsLoyalty)
        {
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Chương trình Thân thiết</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-5">Cấp độ:</dt>
                        <dd class="col-sm-7">
                            <span class="badge
                                    @(Model.LoyaltyTier == "Gold" ? "bg-warning text-dark" :
                                                                    Model.LoyaltyTier == "Silver" ? "bg-secondary" :
                                                                    "bg-info")">
                            <strong>@Model.LoyaltyTier</strong>
                        </span>
                    </dd>
                    <dt class="col-sm-5">Chi tiêu TL:</dt>
                    <dd class="col-sm-7">
                        <strong class="text-success">@Model.TotalSpent.ToString("N0") VNĐ</strong>
                    </dd>
                    <dt class="col-sm-5">Tổng đơn:</dt>
                    <dd class="col-sm-7">@Model.TotalOrders đơn hàng</dd>
                </dl>
                <div class="mt-3 text-center">
                    <a asp-area="Admin" asp-controller="Customer" asp-action="EditLoyalty" asp-route-id="@Model.CustomerID"
                       class="btn btn-sm btn-outline-info" title="Chỉnh sửa cấp độ">
                        <i class="fas fa-edit"></i> Chỉnh sửa Cấp độ
                    </a>
                </div>
            </div>
        </div>
                }
    </div>

    @* PHẦN 2: LỊCH SỬ ĐƠN HÀNG *@
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">Lịch sử Đơn hàng (@(sortedOrders?.Count ?? 0) đơn)</h5>
            </div>
            <div class="card-body">
                @if (sortedOrders == null || !sortedOrders.Any())
                {
                    <p class="text-muted text-center">Khách hàng này chưa có đơn hàng nào.</p>
                }
                else
                {
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Mã ĐH</th>
                                <th>Ngày</th>
                                <th>Tổng tiền</th>
                                <th>Giảm giá</th>
                                <th>Thành tiền</th>
                                <th>Trạng thái</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var order in sortedOrders)
                            {
                                <tr>
                                    <td>#@order.OrderID</td>
                                    <td>@order.OrderDate.ToString("dd/MM/yy HH:mm")</td>
                                    <td>@order.TotalAmount.ToString("N0")</td>
                                    <td>- @order.DiscountAmount.ToString("N0")</td>
                                    <td><strong class="text-success">@order.FinalAmount.ToString("N0")</strong></td>
                                    <td>
                                        <span class="badge @(order.Status == "Completed" ? "bg-success" : "bg-danger")">
                                            @order.Status
                                        </span>
                                    </td>
                                    <td>
                                        @* Link đến chi tiết đơn hàng trong OrderController *@
                                        <a asp-area="Admin" asp-controller="Order" asp-action="Details" asp-route-id="@order.OrderID" class="btn btn-sm btn-outline-secondary">
                                            Xem chi tiết
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a asp-area="Admin" asp-controller="Customer" asp-action="Index" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Quay lại Danh sách
    </a>
</div>